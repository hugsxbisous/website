<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>News Feed</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 0; padding: 12px; }
    .item { border: 1px solid #ddd; border-radius: 10px; padding: 10px; margin: 10px 0; }
    .date { font-size: 12px; color: #555; margin-bottom: 6px; }
    .title { font-weight: 700; margin: 0 0 6px 0; }
    .summary { margin: 0; line-height: 1.35; }
  </style>
</head>
<body>
  <div id="feed">Loadingâ€¦</div>

  <script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRncKg3JL_B8hJaX9zIXT1eCeBoUIVMK3co3t3nyTo-4hCW8peCjqA8jD63lm8TZUAaPiEiYPdYUBpx/pub?output=csv"; // Published-to-web CSV link

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, m => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
      })[m]);
    }

    function parseCSV(text) {
      // Small CSV parser: handles quoted fields and commas inside quotes
      const rows = [];
      let row = [], field = "", inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const c = text[i], n = text[i + 1];

        if (c === '"' && inQuotes && n === '"') { field += '"'; i++; continue; }
        if (c === '"') { inQuotes = !inQuotes; continue; }

        if (c === "," && !inQuotes) { row.push(field); field = ""; continue; }
        if (c === "\n" && !inQuotes) { row.push(field); rows.push(row); row = []; field = ""; continue; }
        if (c !== "\r") field += c;
      }
      if (field.length || row.length) { row.push(field); rows.push(row); }
      return rows;
    }

    function rowsToItems(rows) {
      const headers = rows[0].map((h, i) => {
  let s = (h ?? "").trim().toLowerCase();
  if (i === 0) s = s.replace(/^\uFEFF/, ""); // strip UTF-8 BOM if present
  return s;
});
      const iDate = headers.indexOf("date");
      const iTitle = headers.indexOf("title");
      const iSummary = headers.indexOf("summary");

      if (iDate === -1 || iTitle === -1 || iSummary === -1) {
        throw new Error("Sheet must have headers: date, title, summary");
      }

      return rows.slice(1)
        .filter(r => r.some(x => String(x).trim() !== ""))
        .map(r => ({
          date: (r[iDate] ?? "").trim(),
          title: (r[iTitle] ?? "").trim(),
          summary: (r[iSummary] ?? "").trim()
        }))
        .filter(it => it.date || it.title || it.summary);
    }

    function render(items) {
      // Sort newest first (expects YYYY-MM-DD; falls back safely)
      items.sort((a, b) => (new Date(b.date || "1970-01-01")) - (new Date(a.date || "1970-01-01")));

      const html = items.map(it => `
        <div class="item">
          <div class="date">${escapeHtml(it.date)}</div>
          <div class="title">${escapeHtml(it.title)}</div>
          <p class="summary">${escapeHtml(it.summary)}</p>
        </div>
      `).join("");

      document.getElementById("feed").innerHTML = html || "No items yet.";
    }

    async function main() {
      // Cache-buster: prevents stale CSV responses
      const url = new URL(CSV_URL);
      url.searchParams.set("_ts", Date.now());

      const res = await fetch(url.toString(), { cache: "no-store" });
      if (!res.ok) throw new Error("Failed to fetch sheet CSV");
      const text = await res.text();

      const rows = parseCSV(text);
      if (rows.length < 2) { document.getElementById("feed").textContent = "No items yet."; return; }

      const items = rowsToItems(rows);
      render(items);
    }

    main().catch(err => {
      console.error(err);
      document.getElementById("feed").textContent =
        "Error loading feed. Check that your CSV is published and headers are date,title,summary.";
    });
  </script>
</body>
</html>